<!DOCTYPE html>
<html>
    <head>
        <style>
            body {
                margin: 0;
            }
            button {
                margin: 12px;
            }
            .header {
                width: 100vw;
                height: 20vh;
                background: lightblue;
                justify-content: left;
                align-items: center;
                display: flex;
            }
            .platform {
                width: 100vw;
                height: 80vh;
                background: white;
            }
            .block {
                width: 50px;
                height: 50px;
            }
        </style>
        <script>
            isBetween = (x, a, b) => x >= a && x <= b

            generateBlock = (_) => {
                if (document.querySelectorAll(".spawnpoint > .block").length > 0) return;
                block = document.createElement("div")
                r = Math.random() * 255
                g = Math.random() * 255
                b = Math.random() * 255
                block.style.background = `rgb(${r}, ${g}, ${b})`
                block.classList.add("block")
                block.ondragstart = blockOnDragStart
                block.ondragover = blockOnDragOver
                block.ondragend = blockOnDragEnd
                block.draggable = true
                document.querySelector(".spawnpoint").appendChild(block)
            }

            var currentDrag = null
            var currentDragElementOffset = {x: 0, y: 0}

            blockOnDragStart = (ev) => {
                currentDrag = ev.currentTarget;
                currentDragPos = currentDrag.getBoundingClientRect()
                currentDragElementOffset = {x: parseInt(ev.clientX - currentDragPos.x), y: parseInt(ev.clientY - currentDragPos.y)}
                currentDrag.style.position = "absolute"
            }

            blockOnDragEnd = (ev) => {
                currentDrag = null;
                currentDragElementOffset = {x: 0, y: 0}
            }

            blockOnDragOver = (ev) => {
                ev.preventDefault()
            }

            removeCollisions = (blockPos) => {
                let didCollide = false
                document.querySelectorAll(".block").forEach(pBlock => { 
                    let top = pBlock.getBoundingClientRect().y
                    let bottom = pBlock.getBoundingClientRect().y + 50
                    let left = pBlock.getBoundingClientRect().x
                    let right = pBlock.getBoundingClientRect().x + 50
                    // Top-left
                    if (isBetween(blockPos.x, left, right) && isBetween(blockPos.y, top, bottom)) {
                        if (blockPos.x - left > blockPos.y - top) blockPos.x = right + 1
                        else blockPos.y = bottom + 1
                        didCollide = true
                    }
                    // Top-right
                    else if (isBetween(blockPos.x2, left, right) && isBetween(blockPos.y, top, bottom)) {
                        if (right - blockPos.x2 > blockPos.y - top) blockPos.x = left - 51
                        else blockPos.y = bottom + 1
                        didCollide = true
                    }
                    // Bottom-left
                    else if (isBetween(blockPos.x, left, right) && isBetween(blockPos.y2, top, bottom)) {
                        if (blockPos.x - left > bottom - blockPos.y2) blockPos.x = right + 1
                        else blockPos.y = top - 51
                        didCollide = true
                    }
                    // Bottom-right
                    else if (isBetween(blockPos.x2, left, right) && isBetween(blockPos.y2, top, bottom)) {
                        if (right - blockPos.x2 > bottom - blockPos.y2) blockPos.x = left - 51
                        else blockPos.y = top - 51
                        didCollide = true
                    }
                    blockPos.x2 = blockPos.x + 50
                    blockPos.y2 = blockPos.y + 50
                })
                return didCollide
            }

            platformOnDrop = (ev) => {
                currentDrag.parentNode.removeChild(currentDrag)
                let blockPos = {
                    x: ev.clientX - currentDragElementOffset.x,
                    x2: ev.clientX - currentDragElementOffset.x + 50,
                    y: ev.clientY - currentDragElementOffset.y,
                    y2: ev.clientY - currentDragElementOffset.y + 50,
                }
                let hasCollisions = true
                let i = 0
                while (hasCollisions && i < 200) {
                    hasCollisions = removeCollisions(blockPos)
                    i++
                }
                document.querySelector(".platform").appendChild(currentDrag)
                currentDrag.style.left = blockPos.x + "px"
                currentDrag.style.top = blockPos.y + "px"
            }
        </script>
    </head>
    <body>
        <div class="header">
            <button onclick="generateBlock(event)">Generuj klocek</button>
            <div class="spawnpoint"></div>
        </div>
        <div class="platform" ondrop="platformOnDrop(event)" ondragover="blockOnDragOver(event)"></div>
    </body>
</html>